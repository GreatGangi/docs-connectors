= MongoDB - Upgrade and Migrate - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

Upgrade Anypoint Connector for MongoDB (MongoDB Connector) to version 6.0.0.

== Supported Upgrade Paths

[%header,cols="50a,50a"]
|===
|From Version | To Version
|5.3.x |6.0.0
|===

== Changes in This Release

This release contains the following changes:

* Changed configuration and connection types
* Changed operation names, metadata, fields, and values
+
*Reviewers, what values were changed? I do not see them in the PR. Also, were some operations added besides the Object Listener input source?*
+
* Changed input sources


=== Changes in Configuration and Connection Types

This release contains the following changes to connector configuration:

* Removed Connection String: unified connections in a single Generic Connection. Each property that could be set in the String Connection is now configurable in the Generic Connection
* Removed Metadata configuration section: in the new Connector version metadata is always generated.
* Added Read concern options in Advanced tab, with this fields:
** Read Concern: allows to control the consistency and isolation properties of the data read from replica sets and replica set shards.
** Read Preference: specifies the read preferences for this connection.
** Maximum Staleness Seconds: specifies how stale a secondary can be before the client stops using it for read operations. A value of -1 as ‘no max staleness’.
** Read Preference Tags: if a replica set member or members are associated with tags, you can specify a tag set in the read preference to target those members.
* Added Write concern options in Advanced tab, with this fields:
** Write Concern Acknowledgment: requests acknowledgment that the write operation has propagated to the specified number of instances.
** Write Concern Timeout: specifies a time limit for the write concern.
** Write Concern Timeout Timeunit: time unit for the WriteConcern timeout.

Changes in Generic Connection:

* In General tab:
** Required Libraries: reference to the MongoDB Driver, its version must be 3.11 or higher.
** Server Addresses field has change: now is a list of server addresses to use for this connection.
* New Security tab for TLS context configuration.
* In Advance tab, new parameters were added:
** Authentication Mechanism: The authentication Mechanism used for this connection.
** Replica Set Name: the name of the replica set to connect to.
** Authentication Source: specify the database name associated with the user’s credentials.
** Compressors: list of compressors to enable network compression for communication between this client and a mongod/mongos instance.
** Zlib Compression Level: an integer that specifies the compression level if using zlib for network compression. 0 means No Compression, 1-9 are the compression levels, with 1 being the lowest compression level, and 9 the most compressions (and more processing time).
** Connection Timeout: the connection timeout; this is for establishing the socket connections.
** Connection Timeout Time Unit: the Unit for the connectionTimeout.
** Local Threshold: the size of the latency window for selecting among multiple suitable MongoDB instances.
** Local Threshold Time Unit: the localThreshold Time Unit.
** Server Selection Timeout: specifies how long to block for server selection before throwing an exception.
** Server Selection Timeout Time Unit: the serverSelectionTimeout Time Unit.
** Socket Timeout: the  maximum time to wait for a send or receive operation on a socket before the attempt times out.
** Socket Timeout Time Unit: the socketTimeout Time Unit.
** Min Connections Pool Size: the minimum size for the connection pool.
** Max Pool Connections Size: the maximum size for the connection pool.
** Max Wait Queue Time: the maximum wait queue time for the connection pool.
** Max Wait Queue Time Unit: the maximum wait queue time unit for the connection pool.
** Max Connection Lifetime Time: the maximum connection lifetime for the connection pool.
** Max Connection Lifetime Time Unit: the maximum connection lifetime Time Unit for the connection pool.
** Maximum Connection Idle Time: The maximum connection idle time for the connection pool.
** Maximum Connection Idle Unit: The maximum connection idle time Time Unit for the connection pool.





== Changed Operations, Parameters, and Return Types

*Reviewers, I created a table like this for the Salesforce Connector: https://docs.mulesoft.com/connectors/salesforce/salesforce-connector-100-upgrade-migrate#changed-operations-parameters-and-return-types. In this table, we are specific about what the changes were.*

The following table shows changes to operation names, input parameters, and return types:

[%header%autowidth.spread]
|===
|MongoDB 5.x Operation | Changes in MongoDB 6.0

| Dump a| Input Params are now:

 * `OutputDirectory` (String)
 * `OutpuNamePrefix` (String)
 * `Oplog` (No Change)
 * `OperationTimeout` (Integer)
 * `OperationTimeoutUnits` (TimeUnit)

Return type is now a List<String> that points to the created files (each string is a filePath)


| Create Collection a| Input Params are now:

 * `Collection Name` (String)
 * `Capped options` (Object)
 * `Max objects` (Integer: as part of CappedOptions)
 * `Collection size` (Integer: as part of CappedOptions)
 * `Collection Size Data Unit` (TimeUnit: as part of CappedOptions)

| Exists collection | Operation is now called Collection exists.
| List collections | Return type is now a List<String> containing the names of the collections.
| Map reduce objects | Operation is now called Map reduce.

Return type is now a JSON that represent the output specified in the reduce function.

| Create index a| Input Params are now:

 * `Collection Name` (String)
 * `Field name` (String)
 * `Sort order` (Enum: ASC or DESC)
| List indices | Operation is now called List indexes.
| Insert document | Return type is now a Json object with the _id object of the created document.
| Insert documents | Return type is now a Bulk Operation Result which contains a JSON that contains a list of each created record with its status.
| Update documents a| Input Params are now:

 * `Collection Name` (String)
 * `Query` (JSON)
 * `Content to Update` (JSON)
 * `Multiple Update` (Boolean: moved to Advanced tab)
 * `Upsert` (Boolean)

Return type is now a JSON that contains the following structure: { "matched" : int, "modified" : int, upsertedId: JSON }

| Remove documents a| Input Params are now:

 * `Collection Name` (String)
 * `Query` (JSON)

Return type is now a long with the number of deleted records.

| Count documents a| Input Params are now:

 * `Collection Name` (String)
 * `Query` (JSON)

Return type is now a long with the count result.

| Find documents a| Input Params are now:

 * `Collection Name` (String)
 * `Query` (JSON)
 * `Fields` (String)
 * `Sort By` (JSON)
 * `Page Size` (Integer)
 * `Limit` (Integer)
 * `Skip` (Integer)

The operation supports pagination. Each item returned is as JSON.

| Execute command a| Input Params are now:

 * `Command` (JSON)

Return type is now a JSON with the result of the command.

| Create file from payload | Operation is now called Create file.

Return type is now a JSON.

| Find files a| Input Params are now:

 * `Query` (JSON)
 * `Sort By` (JSON)

Return type is now a List of JSON.

| Get file content a| Input Params are now:

 * `File Id` (JSON)

Return type is now a Result object that contains the File Content and the Attributes (JSON).

| Remove files a| Input Params are now:

 * `File Id` (JSON)

|===

== Changed Operations Metadata

MongoDB 5.x generated operations metadata when the user provided a set of documents per collection from which to take the attributes. MongoDB 6.0 generates metadata automatically, based on the latest document in each collection.

=== Metadata in MongoDB v6.0

[%header,cols="34%,33%,33%"]
|===
|Operation Name	| Input Metadata	|Output Metadata

| Insert Document
|Document
| Resolved dynamically based on the selected value of the collection parameter. The connector adds the latest document of the given collection and uses the document's structures structure as input/output metadata.

| Insert Documents
|Document
|Resolved dynamically based on the selected value of the collection parameter. The connector adds the latest document of the given collection and uses the document's structures structure as input/output metadata.

| Update Documents
| N/A
| JSON that contains the following structure: { "matched" : int, "modified" : int, upsertedId: JSON }

| Remove Documents
| Query: JSON Object
| N/A

| Count Documents
| Query: JSON Object
| N/A

| Find Documents
| Query: JSON Object
| Resolved dynamically based on the selected value of the collection parameter. The connector uses the structure of the first document in the given collection.
*Reviwers, in the last sentence, what does the connector use the structure of the first document for?*

| Create File
| N/A
a|** A GridFS JSON object with the following structure:
* JSON Id
* String fileName
* Long Length
* Int ChunkSize
* Datetime uploadDate
* JSON Metadata

| Find Files
| N/A
a|** List of GridFS JSON object with the following attributes:
* JSON Id
* String fileName
* Long Length
* Int ChunkSize
* Datetime uploadDate
* JSON Metadata
|===

== Removed Operations

The following operations were removed from the MongoDB connector:

[%header,cols="15%,35%,15%,35%"]
|===
2+|Removed from MongoDB 5.x 2+| Can be reproduced in MongoDB 6.0.0 through
|Name	| Description	|Name	|Description
|Incremental dump | Executes an incremental dump of the database. | Dump | Use the Dump operation.
|Restore | Takes the output from the dump and restores it | Restore from file or Restore from directory | These operations take the output from the dump file or directory and restore it.
|Update documents by function | Update documents using a Mongo function | N/A | N/A
|Update documents by functions | Update documents using one or more Mongo functions | N/A | N/A
|Find one and update document | Finds and updates the first document that matches a given query | N/A | This operation's functionality can be reproduced by combining other operations
*Reviewers, can you provide examples*
|Save document | Inserts or updates a document based on its object ID | N/A | N/A
|Find one document | Finds the first document that matches a given query | Find documents | Set the Limit=1 to return one document.
|Execute generic command | Executes a generic command on the database | Execute command | Executes a command on the database
|List files | Lists all files that match the given query and sorts them by filename | N/A | N/A
|Find one file | Returns the first file that matches the given query | Find files | Giving a specific file to the query
|===

== Changes in Input Sources
MongoDB 6.0.0 has one input source only, Object Listener, which retrieves all of the created documents that belong to a specific collection.

The Delete Sources and Update Sources input sources were removed.
+
*Reviewers, I don't see these sources. The only sources I see in the Reference Guide are Deleted Object, Modified Object, and New Object. Do you mean that these sources were removed?*

=== Metadata in Object Listener

[%header,cols="50%,50%"]
|===
|Input Metadata	|Output Metadata

| N/A
| The connector resolves output metadata dynamically based on the selected value of the Collection Name parameter. The connector reads the last document of the given collection and uses the document's structure as output metadata.
|===

== Requirements and Limitations

== Upgrade Prerequisites

Before you perform the upgrade, you must:

. Create a backup of your files, data, and configuration in case you need to restore to the previous version.
.Install MongoDB v6.0 to replace the MongoDB operations that were previously included in MongoDB Connector v5.x.

== Upgrade Steps

Follow these steps to perform the upgrade from MongoDB Connector v5.3.x to MongoDB Connector v6.0:

. In Anypoint Studio, create a Mule project.
. In the Mule Palette view, click Search in Exchange.
. In the *Add Dependencies to Project* window, enter `MongoDB` in the search field.
. In the *Available modules* section, select *MongoDB 6.0* and click *Add*.
. Click *Finish*.
. Verify that the salesforce-connector dependency version is 6.0.0 in the `pom.xml` file.

Studio upgrades the connector automatically.

== Verify the Upgrade

After you install the latest version of the connector, follow these steps to verify the upgrade:

. In Studio, verify that there are no errors in the *Problems* or *Console* views.
. Check the project `pom.xml` file and verify that there are no problems.
. Test the connection and verify that the operations work.

== Troubleshooting

If there are problems with caching the parameters and metadata, try restarting Studio.

== Revert the Upgrade

If it is necessary to revert to the previous version of MongoDB Connector, change the mule-mongodb-connector dependency version 6.0.0 in the project’s `pom.xml` to the previous version.

== See Also

*  xref:introduction/introduction-to-anypoint-connectors.adoc[Introduction to Anypoint Connectors]
* https://help.mulesoft.com[MuleSoft Help Center]
